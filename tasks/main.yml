---
# tasks/main.yml

- name: ocStore | Sync | Set current environment
  set_fact:
    ocstore_environment: "{{ lookup('env','ANSIBLE_ENV') | default('development') }}"
  run_once: true
  when: ocstore_environment is not defined

- name: ocStore | Deploy | Get web server owner group name
  shell: "ps axo user,group,comm | egrep '(apache|httpd)' | grep -v ^root | uniq | cut -d ' ' -f 2"
  register: ocstore_www_owner_group
  run_once: true
  when: ocstore_www_owner_group is not defined
  become: yes

- name: ocStore | Deploy | Check web server owner group name
  fail: msg="Could not get web server owner group name!"
  when: ocstore_www_owner_group.stdout == ''
  
- name: ocStore | Deploy | Set default web server owner group name
  set_fact:
    ocstore_www_owner_group: "{{ ocstore_www_owner_group.stdout }}"
  run_once: true

- name: ocStore | Deploy | Set web server owner user name
  set_fact:
    ocstore_www_owner_user: "{{ ansible_env.USER }}"
  run_once: true
  when: ocstore_www_owner_user is not defined
  
- name: ocStore | Sync | Upload files
  synchronize:
    archive: "yes"
    compress: "yes"
    mode: "push"
    src: "{{ playbook_dir }}/{{ ocstore_sync_dir }}/{{ item.path }}"
    dest: "{{ ocstore_www_root }}/{{ item.path }}"
  with_items: "{{ ocstore_sync_to }}"
  become: yes
